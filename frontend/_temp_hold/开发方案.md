# NanoBananaPro 批量图片生成应用 - 前端开发方案

## 项目概述

开发一个高性能、低内存占用的网页应用，用于批量调用 NanoBananaPro（Gemini Image Generation API）生成图片。

**技术栈**：
- **框架**：React + TypeScript + Vite + TailwindCSS + Zustand
- **状态管理**：Zustand
- **HTTP 客户端**：Axios
- **WebSocket**：原生 WebSocket API

---

## 1.1 技术栈详解

| 技术 | 版本 | 用途 |
|------|------|------|
| React | 18.x | UI 框架 |
| TypeScript | 5.x | 类型安全 |
| Vite | 5.x | 构建工具 |
| TailwindCSS | 3.x | 样式框架 |
| Zustand | 4.x | 状态管理 |
| React Query | 5.x | 服务端状态缓存 |
| Axios | 1.x | HTTP 客户端 |

---

## 1.2 页面布局设计

采用左右两栏布局，右侧使用 **Tab 切换** 在「生成区域」和「历史记录」之间切换：

```
+------------------------------------------------------------------+
|                        Header（顶部导航栏）                        |
+----------+-------------------------------------------------------+
|  配置栏   |  [生成区域]  [历史记录]  ← Tab 切换                    |
|  (25%)   +-------------------------------------------------------+
|          |                                                       |
| [模型选择]|   当前 Tab = 生成区域时：                              |
| [提示词]  |      图片网格展示                                     |
| [数量]   |      □  □  □  □                                      |
| [尺寸]   |      □  □  □  □                                      |
| [高级选项]|      [进度条] 5/10                                    |
| [生成]   |      [全选] [导出] [删除]                              |
|          |                                                       |
|          |   当前 Tab = 历史记录时：                              |
|          |      [搜索框]                                         |
|          |      历史记录列表（虚拟滚动）                           |
|          |      [加载更多]                                        |
+----------+-------------------------------------------------------+
```

**Tab 切换设计优势**：
- 界面更简洁，减少视觉干扰
- 在小屏幕上有更好的显示效果
- 用户可以专注于当前操作

---

## 1.3 组件结构

```
src/components/
├── Layout/
│   ├── Header.tsx              # 顶部导航栏
│   └── MainLayout.tsx          # 三栏主布局
├── ConfigPanel/                # 左侧配置栏
│   ├── index.tsx               # 配置栏容器
│   ├── ApiKeyInput.tsx         # API Key 输入框
│   ├── ModelSelector.tsx       # 模型下拉选择
│   ├── PromptInput.tsx         # 提示词多行文本框
│   ├── BatchSettings.tsx       # 批量设置（数量、尺寸）
│   ├── AdvancedOptions.tsx     # 高级选项（可折叠）
│   └── GenerateButton.tsx      # 生成按钮
├── GenerateArea/               # 中间生成区域
│   ├── index.tsx               # 生成区域容器
│   ├── ProgressBar.tsx         # 进度条
│   ├── ImageGrid.tsx           # 图片网格
│   ├── ImageCard.tsx           # 单张图片卡片
│   ├── ImagePreview.tsx        # 图片预览弹窗
│   └── BatchActions.tsx        # 批量操作（全选、导出、删除）
├── HistoryPanel/               # 右侧历史记录
│   ├── index.tsx               # 历史面板容器
│   ├── SearchBar.tsx           # 搜索栏
│   ├── HistoryList.tsx         # 历史列表（虚拟滚动）
│   ├── HistoryItem.tsx         # 单条历史记录
│   └── LoadMore.tsx            # 加载更多按钮
└── common/                     # 通用组件
    ├── Button.tsx
    ├── Modal.tsx
    ├── Loading.tsx
    └── Toast.tsx
```

---

## 1.4 状态管理设计（Zustand）

### configStore.ts - 配置状态
```typescript
interface ConfigState {
  apiKey: string;                    // Google API Key
  model: string;                     // 模型选择
  prompt: string;                    // 提示词
  count: number;                     // 生成数量（1-10）
  imageSize: '1K' | '2K' | '4K';     // 图片分辨率
  aspectRatio: string;               // 宽高比
  // Actions
  setApiKey: (key: string) => void;
  setModel: (model: string) => void;
  setPrompt: (prompt: string) => void;
  setCount: (count: number) => void;
  setImageSize: (size: string) => void;
  setAspectRatio: (ratio: string) => void;
  reset: () => void;
}
```

### generateStore.ts - 生成任务状态
```typescript
interface GenerateState {
  taskId: string | null;             // 当前任务 ID
  status: 'idle' | 'processing' | 'completed' | 'failed';
  totalCount: number;                // 总数量
  completedCount: number;            // 已完成数量
  images: GeneratedImage[];          // 生成的图片列表
  selectedIds: Set<string>;          // 选中的图片 ID
  error: string | null;
  // Actions
  startTask: (taskId: string, totalCount: number) => void;
  updateProgress: (completedCount: number, image?: GeneratedImage) => void;
  completeTask: () => void;
  failTask: (error: string) => void;
  toggleSelect: (id: string) => void;
  selectAll: () => void;
  clearSelection: () => void;
  clearImages: () => void;
}
```

### historyStore.ts - 历史记录状态
```typescript
interface HistoryState {
  items: HistoryItem[];              // 历史记录列表
  loading: boolean;                  // 加载状态
  hasMore: boolean;                  // 是否有更多
  searchKeyword: string;             // 搜索关键词
  // Actions
  loadHistory: () => Promise<void>;
  loadMore: () => Promise<void>;
  setSearchKeyword: (keyword: string) => void;
  deleteItem: (id: string) => Promise<void>;
  deleteItems: (ids: string[]) => Promise<void>;
}
```

---

## 1.5 API 服务封装

### services/api.ts - Axios 配置
```typescript
const api = axios.create({
  baseURL: '/api/v1',
  timeout: 60000,
});

// 请求拦截器：添加 API Key
api.interceptors.request.use((config) => {
  const apiKey = useConfigStore.getState().apiKey;
  if (apiKey) {
    config.headers['X-API-Key'] = apiKey;
  }
  return config;
});
```

### services/generateApi.ts - 生成相关 API
```typescript
// 批量生成图片
export const generateBatch = (params: BatchGenerateRequest) =>
  api.post<BatchGenerateResponse>('/generate/batch', params);

// 查询任务状态
export const getTaskStatus = (taskId: string) =>
  api.get<TaskStatusResponse>(`/generate/status/${taskId}`);
```

### services/historyApi.ts - 历史记录 API
```typescript
// 获取历史列表
export const getHistory = (params: HistoryQueryParams) =>
  api.get<HistoryListResponse>('/history', { params });

// 删除历史记录
export const deleteHistory = (id: string) =>
  api.delete(`/history/${id}`);

// 批量导出图片
export const exportImages = (ids: string[]) =>
  api.post('/images/export', { ids }, { responseType: 'blob' });
```

---

## 1.6 自定义 Hooks

### useWebSocket.ts - WebSocket 连接
```typescript
export function useWebSocket(taskId: string | null) {
  const updateProgress = useGenerateStore((s) => s.updateProgress);
  const completeTask = useGenerateStore((s) => s.completeTask);

  useEffect(() => {
    if (!taskId) return;

    const ws = new WebSocket(`ws://${location.host}/api/v1/ws/generate/${taskId}`);

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      if (data.type === 'progress') {
        updateProgress(data.completedCount, data.latestImage);
      } else if (data.type === 'completed') {
        completeTask();
      }
    };

    return () => ws.close();
  }, [taskId]);
}
```

### useGenerate.ts - 生成逻辑
```typescript
export function useGenerate() {
  const config = useConfigStore();
  const { startTask, status } = useGenerateStore();

  const generate = async () => {
    const response = await generateBatch({
      model: config.model,
      prompt: config.prompt,
      count: config.count,
      imageSize: config.imageSize,
      aspectRatio: config.aspectRatio,
    });
    startTask(response.data.taskId, config.count);
  };

  return { generate, isProcessing: status === 'processing' };
}
```

---

## 1.7 前端开发步骤

| 步骤 | 任务 | 关键文件 |
|------|------|----------|
| 1 | 初始化 Vite + React + TypeScript 项目 | `vite.config.ts`, `tsconfig.json` |
| 2 | 安装并配置 TailwindCSS | `tailwind.config.js`, `index.css` |
| 3 | 创建三栏主布局组件 | `MainLayout.tsx` |
| 4 | 实现 Zustand Store | `configStore.ts`, `generateStore.ts`, `historyStore.ts` |
| 5 | 实现配置栏组件 | `ConfigPanel/index.tsx` 及子组件 |
| 6 | 实现图片网格组件 | `ImageGrid.tsx`, `ImageCard.tsx` |
| 7 | 实现 WebSocket Hook | `useWebSocket.ts` |
| 8 | 实现进度条和状态展示 | `ProgressBar.tsx` |
| 9 | 实现图片预览弹窗 | `ImagePreview.tsx` |
| 10 | 实现批量操作（导出/删除） | `BatchActions.tsx` |
| 11 | 实现历史记录面板 | `HistoryPanel/index.tsx` 及子组件 |
| 12 | 实现虚拟滚动优化 | `HistoryList.tsx` |
| 13 | 响应式布局适配 | 全局样式调整 |

---

## 1.8 前端优化与精进方向

### 1.8.1 UI/UX 体验优化
- **响应式与自适应**：在移动端或小屏幕上将左侧配置栏转为抽屉式（Drawer）设计，最大化图片展示空间。
- **沉浸式预览增强**：图片预览弹窗增加"对比模式"和"参数浮层"（直接显示该图对应的 Prompt 和参数）。
- **暗黑模式支持**：原生支持 Tailwind CSS 的 Dark Mode，适应不同光线环境下的工作需求。
- **交互细节**：
    - **空状态设计**：增加优雅的 Empty States 提示。
    - **骨架屏（Skeleton）**：在历史记录和图片加载时使用骨架屏代替简单 Loading，提升感知性能。

### 1.8.2 架构与性能优化
- **图片懒加载与分级加载**：列表展示使用后端生成的 Thumbnail 缩略图，点击预览后再加载原图；支持 Intersection Observer 懒加载。
- **状态持久化**：使用 Zustand 的 persist 中间件持久化存储 API Key 和模型配置。
- **鲁棒性增强**：针对 WebSocket 增加指数退避算法的自动重连机制；完善 Axios 全局错误拦截提示。
- **表单校验**：引入 React Hook Form 或 Zod，在前端预先校验 Prompt 长度和 API Key 格式。

### 1.8.3 功能增强建议
- **Prompt 助手**：内置常用风格标签库（Tags）及变量模板功能，支持批量替换变量生成图片。
- **轻量编辑**：集成简易 Canvas 或 CSS 滤镜，支持导出前的快速裁剪和色彩微调。
- **多样化导出**：除 ZIP 导出外，增加"一键复制图片/Base64"及社交平台一键分享功能。

---

## 前端关键文件清单

| 文件路径 | 说明 |
|----------|------|
| `frontend/src/App.tsx` | 应用入口 |
| `frontend/src/components/Layout/MainLayout.tsx` | 三栏主布局 |
| `frontend/src/components/ConfigPanel/index.tsx` | 配置栏容器 |
| `frontend/src/components/GenerateArea/ImageGrid.tsx` | 图片网格 |
| `frontend/src/components/HistoryPanel/index.tsx` | 历史面板 |
| `frontend/src/store/generateStore.ts` | 生成状态管理 |
| `frontend/src/hooks/useWebSocket.ts` | WebSocket Hook |
| `frontend/src/services/generateApi.ts` | 生成 API 封装 |
