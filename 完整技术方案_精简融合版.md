# å›¾ç‰‡ç”ŸæˆæœåŠ¡ - å®Œæ•´æŠ€æœ¯æ–¹æ¡ˆï¼ˆç²¾ç®€ç‰ˆï¼‰

> **é€‚ç”¨åœºæ™¯**ï¼š2C2G CentOSå•æœºï¼Œ10-100å¹¶å‘ï¼Œä¸­æ–‡æœç´¢

---

## ğŸ“‹ ç›®å½•

1. [æ ¸å¿ƒéœ€æ±‚](#æ ¸å¿ƒéœ€æ±‚)
2. [æŠ€æœ¯æ¶æ„](#æŠ€æœ¯æ¶æ„)
3. [æ ¸å¿ƒæŠ€æœ¯æ–¹æ¡ˆ](#æ ¸å¿ƒæŠ€æœ¯æ–¹æ¡ˆ)
4. [æ•°æ®åº“è®¾è®¡](#æ•°æ®åº“è®¾è®¡)
5. [APIæ¥å£è®¾è®¡](#apiæ¥å£è®¾è®¡)
6. [ä¸­æ–‡æœç´¢](#ä¸­æ–‡æœç´¢)
7. [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
8. [éƒ¨ç½²æ–¹æ¡ˆ](#éƒ¨ç½²æ–¹æ¡ˆ)
9. [å®Œæ•´ä»£ç ](#å®Œæ•´ä»£ç )
10. [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)

---

## ğŸ¯ æ ¸å¿ƒéœ€æ±‚

### åŠŸèƒ½éœ€æ±‚
- âœ… å›¾ç‰‡ç”Ÿæˆï¼ˆå¯¹æ¥ç¬¬ä¸‰æ–¹APIï¼‰
- âœ… æœ¬åœ°å­˜å‚¨ + OSSäº‘å­˜å‚¨
- âœ… æ¥å£ï¼šåˆ—è¡¨ã€è¯¦æƒ…ã€åˆ é™¤ã€ç”Ÿæˆ
- âœ… ä¸­æ–‡æœç´¢ï¼ˆæŒ‰promptï¼‰
- âœ… é«˜æ€§èƒ½ç¨³å®š

### æŠ€æœ¯çº¦æŸ
- âœ… Goè¯­è¨€
- âœ… å•æœºéƒ¨ç½²ï¼ˆ2C2Gï¼‰
- âœ… 10-100å¹¶å‘
- âœ… ç®€å•æ˜“ç»´æŠ¤

---

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å®¢æˆ·ç«¯ï¼ˆWeb/å°ç¨‹åº/Appï¼‰          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ HTTP API
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Go HTTPæœåŠ¡ï¼ˆGinæ¡†æ¶ï¼‰             â”‚
â”‚  - RESTful API                             â”‚
â”‚  - ä¸­é—´ä»¶ï¼ˆæ—¥å¿—ã€æ¢å¤ï¼‰                      â”‚
â”‚  - å‚æ•°éªŒè¯                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          ä»»åŠ¡é˜Ÿåˆ—ï¼ˆChannelï¼‰                 â”‚
â”‚          å¤§å°ï¼š100ä¸ªä»»åŠ¡                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Workeræ± ï¼ˆ6ä¸ªworkerï¼‰               â”‚
â”‚  - å¹¶å‘æ§åˆ¶                                 â”‚
â”‚  - ä»»åŠ¡æ‰§è¡Œ                                 â”‚
â”‚  - é”™è¯¯é‡è¯•                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼          â–¼          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Provider  â”‚ â”‚  SQLite  â”‚ â”‚  å­˜å‚¨    â”‚
â”‚  æŠ½è±¡å±‚   â”‚ â”‚  æ•°æ®åº“  â”‚ â”‚  æœ¬åœ°+OSSâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶

| ç»„ä»¶ | æŠ€æœ¯é€‰å‹ | è¯´æ˜ |
|------|---------|------|
| Webæ¡†æ¶ | Gin | è½»é‡çº§é«˜æ€§èƒ½ |
| æ•°æ®åº“ | SQLite | é›¶é…ç½®ï¼Œå•æœºé¦–é€‰ |
| é˜Ÿåˆ— | Channel | åŸç”Ÿï¼Œç®€å•é«˜æ•ˆ |
| Workeræ±  | Goroutine | 6ä¸ªworkerï¼ˆ2C2Gï¼‰ |
| å­˜å‚¨ | æœ¬åœ°+OSS | æœ¬åœ°7å¤©+OSSæ°¸ä¹… |
| æ—¥å¿— | logæ ‡å‡†åº“ | ç®€å•å¤Ÿç”¨ |
| ç›‘æ§ | healthæ¥å£ | ç®€å•å®ç”¨ |

---

## ğŸ”§ æ ¸å¿ƒæŠ€æœ¯æ–¹æ¡ˆ

### 1. HTTPè¿æ¥æ± ï¼ˆå¿…é¡»ï¼‰

**é—®é¢˜**ï¼šé˜²æ­¢"bad file descriptor"

```go
transport := &http.Transport{
    // å…³é”®ï¼šå°äºæœåŠ¡ç«¯è¶…æ—¶
    IdleConnTimeout:       30 * time.Second,
    MaxIdleConns:          50,
    MaxIdleConnsPerHost:   10,
    TLSHandshakeTimeout:   10 * time.Second,
    ResponseHeaderTimeout: 30 * time.Second,
}

client := &http.Client{
    Transport: transport,
    Timeout:   30 * time.Second,
}
```

---

### 2. æµå¼å¤„ç†å›¾ç‰‡ï¼ˆå¿…é¡»ï¼‰

**é—®é¢˜**ï¼šé˜²æ­¢å†…å­˜æ’‘çˆ†

```go
// âœ… æµå¼å¤„ç†ï¼šè¾¹ä¸‹è½½è¾¹ä¸Šä¼ 
func downloadAndUpload(url string) error {
    resp, _ := http.Get(url)
    defer resp.Body.Close()

    // ç›´æ¥æµå¼ä¸Šä¼ åˆ°OSS
    return ossClient.UploadStream(resp.Body)
}

// âŒ ä¸è¦è¿™æ ·ï¼šä¼šæ’‘çˆ†å†…å­˜
// data, _ := io.ReadAll(resp.Body) // å±é™©ï¼
```

---

### 3. Workeræ± ï¼ˆå¿…é¡»ï¼‰

**é—®é¢˜**ï¼šæ§åˆ¶å¹¶å‘ï¼ˆ2C2Gæ¨è6ä¸ªworkerï¼‰

```go
type WorkerPool struct {
    workerCount int
    taskQueue   chan *Task
}

func NewWorkerPool(workerCount, queueSize int) *WorkerPool {
    return &WorkerPool{
        workerCount: workerCount,
        taskQueue:   make(chan *Task, queueSize),
    }
}

func (wp *WorkerPool) Start() {
    for i := 0; i < wp.workerCount; i++ {
        go wp.worker(i)
    }
}

func (wp *WorkerPool) worker(id int) {
    for task := range wp.taskQueue {
        processTask(task)
    }
}
```

---

### 4. ProvideræŠ½è±¡å±‚ï¼ˆé€šç”¨æ€§ï¼‰

**é—®é¢˜**ï¼šå¯¹æ¥ä¸åŒå›¾ç‰‡ç”ŸæˆAPI

```go
// Provideræ¥å£
type Provider interface {
    Name() string
    Generate(ctx context.Context, params map[string]interface{}) (*ProviderResult, error)
    ValidateParams(params map[string]interface{}) error
}

// ProviderResult
type ProviderResult struct {
    Images   []string
    Metadata map[string]interface{}
}

// Stable Diffusion Provider
type SDProvider struct {
    apiKey  string
    client  *http.Client
}

// è‡ªå®šä¹‰API Providerï¼ˆé…ç½®é©±åŠ¨ï¼‰
type CustomAPIProvider struct {
    config HTTPProviderConfig
}
```

---

### 5. é‡è¯•æœºåˆ¶ï¼ˆå¿…é¡»ï¼‰

**é—®é¢˜**ï¼šAPIä¸´æ—¶æ•…éšœ

```go
func retryWithBackoff(fn func() error, maxTimes int) error {
    backoff := []time.Duration{1*time.Second, 2*time.Second, 4*time.Second}

    for i, wait := range backoff {
        err := fn()
        if err == nil {
            return nil
        }

        if !isConnectionError(err) {
            return err
        }

        if i < len(backoff) {
            time.Sleep(wait)
        }
    }

    return errors.New("max retries exceeded")
}
```

---

### 6. ä¼˜é›…å…³é—­ï¼ˆå¿…é¡»ï¼‰

**é—®é¢˜**ï¼šé‡å¯ä¸ä¸¢ä»»åŠ¡

```go
func waitForShutdown() {
    sigChan := make(chan os.Signal, 1)
    signal.Notify(sigChan, syscall.SIGINT, syscall.SIGTERM)

    <-sigChan

    // ç­‰å¾…é˜Ÿåˆ—æ¸…ç©ºï¼ˆæœ€å¤š30ç§’ï¼‰
    ctx, cancel := context.WithTimeout(context.Background(), 30*time.Second)
    waitForQueueEmpty(ctx)
    cancel()
}
```

---

## ğŸ’¾ æ•°æ®åº“è®¾è®¡

### è¡¨ç»“æ„

```sql
-- ==========================================
-- Provideré…ç½®è¡¨ï¼ˆæ ¸å¿ƒè¡¨ï¼‰
-- ==========================================
CREATE TABLE provider_configs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    provider_name TEXT NOT NULL UNIQUE,      -- Provideråç§°ï¼š'stable-diffusion', 'openai-dalle', 'custom-api'
    display_name TEXT,                       -- æ˜¾ç¤ºåç§°ï¼š'Stable Diffusion', 'DALL-E'
    api_base TEXT NOT NULL,                  -- APIåŸºç¡€URLï¼šhttps://api.stablediffusion.com/v1
    api_key TEXT NOT NULL,                   -- APIå¯†é’¥ï¼ˆåŠ å¯†å­˜å‚¨ï¼‰
    models TEXT,                             -- æ¨¡å‹åˆ—è¡¨JSONï¼š[{"id":"sd-xl","name":"SD XL","default":true}]
    enabled BOOLEAN DEFAULT 1,               -- æ˜¯å¦å¯ç”¨
    timeout_seconds INTEGER DEFAULT 60,      -- è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰
    max_retries INTEGER DEFAULT 3,           -- æœ€å¤§é‡è¯•æ¬¡æ•°
    extra_config TEXT,                       -- é¢å¤–é…ç½®JSONï¼ˆheadersã€ä»£ç†ç­‰ï¼‰
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- ç´¢å¼•
CREATE INDEX idx_provider_name ON provider_configs(provider_name);
CREATE INDEX idx_enabled ON provider_configs(enabled);

-- ==========================================
-- ä»»åŠ¡è¡¨
-- ==========================================
CREATE TABLE tasks (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    task_id TEXT UNIQUE NOT NULL,
    prompt TEXT NOT NULL,
    provider_name TEXT NOT NULL,             -- ä½¿ç”¨çš„Provider
    model_id TEXT,                           -- ä½¿ç”¨çš„æ¨¡å‹ID
    status TEXT NOT NULL,                    -- pending, processing, completed, failed
    error_message TEXT,
    image_url TEXT,
    local_path TEXT,
    -- é…ç½®å¿«ç…§ï¼ˆç”¨äºè¿½æº¯ï¼‰
    config_snapshot TEXT,                    -- ç”Ÿæˆæ—¶çš„é…ç½®JSONï¼ˆè„±æ•åï¼‰
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    completed_at DATETIME
);

-- ç´¢å¼•
CREATE INDEX idx_status ON tasks(status);
CREATE INDEX idx_created_at ON tasks(created_at);
CREATE INDEX idx_provider ON tasks(provider_name);

-- ==========================================
-- ç´¢å¼•ä¼˜åŒ–ï¼ˆç”¨äºä¸­æ–‡LIKEæœç´¢ï¼‰
-- ==========================================
CREATE INDEX idx_prompt ON tasks(prompt);
CREATE INDEX idx_model ON tasks(model_id);
```

### é…ç½®ä¼˜å…ˆçº§

```
ä¼˜å…ˆçº§ï¼šå‰ç«¯ä¸´æ—¶é…ç½® > å‰ç«¯ä¿å­˜çš„é…ç½® > é…ç½®æ–‡ä»¶é»˜è®¤é…ç½®

1. é…ç½®æ–‡ä»¶ï¼ˆconfig.yamlï¼‰- éƒ¨ç½²æ—¶é¢„è®¾ï¼Œä½œä¸ºfallback
2. æ•°æ®åº“ï¼ˆprovider_configsè¡¨ï¼‰- å‰ç«¯åŠ¨æ€ä¿å­˜
3. è¯·æ±‚å‚æ•°ï¼ˆgenerateæ¥å£ï¼‰- ä¸´æ—¶è¦†ç›–ï¼Œä¸ä¿å­˜
```

---

## ğŸŒ APIæ¥å£è®¾è®¡

### ä¸€ã€Provideré…ç½®ç®¡ç†æ¥å£ï¼ˆæ–°å¢ï¼‰

```bash
# 1. è®¾ç½®/æ›´æ–°Provideré…ç½®
POST /api/v1/providers/config
Content-Type: application/json
{
  "provider_name": "stable-diffusion",
  "display_name": "Stable Diffusion",
  "api_base": "https://api.stablediffusion.com/v1",
  "api_key": "sk-xxxxxxxxx",
  "models": [
    {"id": "sd-xl", "name": "SD XL 1.0", "default": true},
    {"id": "sd-1.5", "name": "SD 1.5"}
  ],
  "enabled": true,
  "timeout_seconds": 60
}

# 2. è·å–Provideré…ç½®
GET /api/v1/providers/config/{provider_name}

# å“åº”ï¼ˆapi_keyéƒ¨åˆ†éšè—ï¼‰
{
  "code": 0,
  "data": {
    "provider_name": "stable-diffusion",
    "display_name": "Stable Diffusion",
    "api_base": "https://api.stablediffusion.com/v1",
    "api_key": "sk-****(éšè—)",
    "models": [...],
    "enabled": true
  }
}

# 3. åˆ—å‡ºæ‰€æœ‰Provideré…ç½®
GET /api/v1/providers/config

# 4. åˆ é™¤Provideré…ç½®
DELETE /api/v1/providers/config/{provider_name}

# 5. å¯ç”¨/ç¦ç”¨Provider
PATCH /api/v1/providers/config/{provider_name}/toggle
{
  "enabled": true
}
```

### äºŒã€æ ¸å¿ƒä¸šåŠ¡æ¥å£

```bash
# 1. ç”Ÿæˆå›¾ç‰‡ï¼ˆæ”¯æŒå¤šç§é…ç½®æ–¹å¼ï¼‰
POST /api/v1/tasks/generate
Content-Type: application/json
{
  "provider": "stable-diffusion",        # Provideråç§°ï¼ˆå¿…é¡»ï¼‰
  "model_id": "sd-xl",                  # æ¨¡å‹IDï¼ˆå¿…é¡»ï¼‰

  # ===== é…ç½®æ¥æºï¼ˆä¸‰é€‰ä¸€ï¼‰ =====

  # æ–¹å¼1ï¼šä½¿ç”¨å·²ä¿å­˜çš„é…ç½®ï¼ˆæ¨èï¼‰
  "use_saved_config": true,

  # æ–¹å¼2ï¼šä¸´æ—¶è¦†ç›–é…ç½®ï¼ˆä¸ä¿å­˜ï¼Œä¼˜å…ˆçº§æœ€é«˜ï¼‰
  "config": {
    "api_base": "https://api.example.com/v1",
    "api_key": "sk-temp-key",
    "timeout": 60
  },

  # æ–¹å¼3ï¼šéƒ½ä¸æä¾›ï¼Œåˆ™ä»æ•°æ®åº“è¯»å–è¯¥providerçš„é…ç½®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰

  # ===== ç”Ÿæˆå‚æ•° =====
  "params": {
    "prompt": "ä¸€åªå¯çˆ±çš„çŒ«",
    "negative_prompt": "blurry, bad quality",
    "width": 1024,
    "height": 1024,
    "steps": 30,
    "cfg_scale": 7.5,
    "num": 1
  }
}

# é”™è¯¯å“åº”ç¤ºä¾‹
{
  "code": 40001,
  "message": "Provideré…ç½®ä¸å­˜åœ¨",
  "data": {
    "provider": "stable-diffusion",
    "hint": "è¯·å…ˆè°ƒç”¨ POST /api/v1/providers/config é…ç½®APIä¿¡æ¯"
  }
}

# 2. æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
GET /api/v1/tasks/{task_id}

# 3. å›¾ç‰‡åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰
GET /api/v1/images?page=1&page_size=20

# 4. å›¾ç‰‡è¯¦æƒ…
GET /api/v1/images/{id}

# 5. åˆ é™¤å›¾ç‰‡
DELETE /api/v1/images/{id}

# 6. ä¸­æ–‡æœç´¢
GET /api/v1/images/search?keyword=å¯çˆ±çš„çŒ«&page=1

# 7. å¥åº·æ£€æŸ¥
GET /health
```

### ä¸‰ã€Google Gemini å›¾ç‰‡ç”Ÿæˆæ¥å£

#### 1. æ–‡ç”Ÿå›¾ï¼ˆText-to-Imageï¼‰

ä½¿ç”¨ Google Imagen 3.0 æ¨¡å‹ç”Ÿæˆå›¾ç‰‡ã€‚

```bash
POST /api/v1/tasks/generate
Content-Type: application/json

{
  "provider": "gemini",
  "model_id": "imagen-3.0-generate-001",
  "use_saved_config": true,
  "params": {
    "prompt": "ä¸€åªå¯çˆ±çš„çŒ«å’ªååœ¨é˜³å…‰æ˜åªšçš„çª—å°ä¸Š",
    "number_of_images": 1
  }
}
```

**æŠ€æœ¯å®ç°**ï¼š
```go
// ä½¿ç”¨ Google Gen AI Go SDK
import "google.golang.org/genai"

func (p *GeminiProvider) Generate(ctx context.Context, params map[string]interface{}) (*ProviderResult, error) {
    prompt := params["prompt"].(string)
    modelID := "imagen-3.0-generate-001"

    // è°ƒç”¨ Imagen API
    result, err := p.client.Models.GenerateImages(
        ctx,
        modelID,
        prompt,
        &genai.GenerateImagesConfig{
            IncludeRAIReason:        true,
            IncludeSafetyAttributes: true,
            OutputMIMEType:          "image/jpeg",
        },
    )

    if err != nil {
        return nil, fmt.Errorf("Google API è°ƒç”¨å¤±è´¥: %w", err)
    }

    // æå–å›¾ç‰‡å­—èŠ‚æµ
    imageBytesList := make([][]byte, 0)
    for _, img := range result.GeneratedImages {
        if img.Image != nil && len(img.Image.ImageBytes) > 0 {
            imageBytesList = append(imageBytesList, img.Image.ImageBytes)
        }
    }

    return &ProviderResult{
        ImageBytes: imageBytesList,
        Metadata: map[string]interface{}{
            "provider": "gemini",
            "model":    modelID,
        },
    }, nil
}
```

#### 2. å›¾ç”Ÿå›¾ï¼ˆImage-to-Image with Reference Imagesï¼‰

ä½¿ç”¨ Gemini 3 Pro Image æ¨¡å‹ï¼Œæ”¯æŒæœ€å¤š 14 å¼ å‚è€ƒå›¾ã€‚

```bash
POST /api/v1/images/generate-with-references
Content-Type: application/json

{
  "provider": "gemini",
  "prompt": "ç”Ÿæˆä¸å‚è€ƒå›¾é£æ ¼ç›¸ä¼¼çš„å›¾ç‰‡ï¼Œä¸€åªå¯çˆ±çš„çŒ«å’ª",
  "reference_images": [
    "data:image/jpeg;base64,/9j/4AAQSkZJRg...",
    "data:image/jpeg;base64,/9j/4AAQSkZJRg..."
  ],
  "image_size": "2K",
  "aspect_ratio": "1:1"
}
```

**æŠ€æœ¯å®ç°**ï¼š
```go
// ä½¿ç”¨ Gemini å¤šæ¨¡æ€æ¨¡å‹
func (p *GeminiProvider) GenerateWithReferenceImages(
    ctx context.Context,
    prompt string,
    referenceImages []ReferenceImage,
    imageSize string,
    aspectRatio string,
) ([]byte, error) {
    // å‚æ•°éªŒè¯
    if len(referenceImages) == 0 {
        return nil, fmt.Errorf("è‡³å°‘éœ€è¦ä¸€å¼ å‚è€ƒå›¾ç‰‡")
    }
    if len(referenceImages) > 14 {
        return nil, fmt.Errorf("å‚è€ƒå›¾ç‰‡æœ€å¤šæ”¯æŒ14å¼ ")
    }

    // æ„å»ºå¤šæ¨¡æ€ Parts
    parts := []*genai.Part{
        {Text: prompt},
    }

    // æ·»åŠ å‚è€ƒå›¾ç‰‡
    for _, refImg := range referenceImages {
        parts = append(parts, &genai.Part{
            InlineData: &genai.Blob{
                Data:     refImg.Data,
                MIMEType: refImg.MIMEType,
            },
        })
    }

    // è°ƒç”¨ GenerateContent API
    content := []*genai.Content{{Parts: parts}}
    resp, err := p.client.Models.GenerateContent(ctx, "gemini-2.0-flash-exp", content, nil)

    if err != nil {
        return nil, fmt.Errorf("è°ƒç”¨ Gemini API å¤±è´¥: %w", err)
    }

    // æå–ç”Ÿæˆçš„å›¾ç‰‡
    for _, candidate := range resp.Candidates {
        for _, part := range candidate.Content.Parts {
            if part.InlineData != nil && len(part.InlineData.Data) > 0 {
                return part.InlineData.Data, nil
            }
        }
    }

    return nil, fmt.Errorf("æœªç”Ÿæˆå›¾ç‰‡")
}
```

#### 3. å›¾ç‰‡ç¼–è¾‘ï¼ˆEdit Imageï¼‰

æ”¯æŒå›¾ç‰‡ä¿®å¤ã€æ·»åŠ /åˆ é™¤/æ›¿æ¢å†…å®¹ã€‚

```bash
POST /api/v1/images/edit
Content-Type: application/json

{
  "provider": "gemini",
  "prompt": "åœ¨å›¾ç‰‡å³ä¾§æ·»åŠ ä¸€æ£µå¤§æ ‘",
  "image": "data:image/jpeg;base64,...",
  "edit_mode": "EDIT_MODE_INPAINT_INSERTION"
}
```

**æŠ€æœ¯å®ç°**ï¼š
```go
func (p *GeminiProvider) EditImage(ctx context.Context, prompt string, imageBytes []byte, editMode string) ([]byte, error) {
    if editMode == "" {
        editMode = "EDIT_MODE_INPAINT_INSERTION"
    }

    // åˆ›å»ºå‚è€ƒå›¾ç‰‡
    rawRefImg := &genai.RawReferenceImage{
        ReferenceImage: &genai.Image{ImageBytes: imageBytes},
        ReferenceID:    1,
    }

    // è°ƒç”¨ EditImage API
    result, err := p.client.Models.EditImage(
        ctx,
        "imagen-3.0-capability-001",
        prompt,
        []genai.ReferenceImage{rawRefImg},
        &genai.EditImageConfig{
            EditMode:         genai.EditMode(editMode),
            IncludeRAIReason: true,
            OutputMIMEType:   "image/jpeg",
        },
    )

    if err != nil {
        return nil, fmt.Errorf("ç¼–è¾‘å›¾ç‰‡å¤±è´¥: %w", err)
    }

    if len(result.GeneratedImages) == 0 {
        return nil, fmt.Errorf("æœªç”Ÿæˆç¼–è¾‘åçš„å›¾ç‰‡")
    }

    return result.GeneratedImages[0].Image.ImageBytes, nil
}
```

#### 4. å›¾ç‰‡æ”¾å¤§ï¼ˆUpscaleï¼‰

æ”¯æŒ x2ã€x4 å€æ”¾å¤§å¹¶å¢å¼ºè´¨é‡ã€‚

```bash
POST /api/v1/images/upscale

{
  "provider": "gemini",
  "image": "data:image/jpeg;base64,...",
  "upscale_factor": "x2"
}
```

**æŠ€æœ¯å®ç°**ï¼š
```go
func (p *GeminiProvider) UpscaleImage(ctx context.Context, imageBytes []byte, upscaleFactor string) ([]byte, error) {
    if upscaleFactor == "" {
        upscaleFactor = "x2"
    }

    result, err := p.client.Models.UpscaleImage(
        ctx,
        "imagen-3.0-generate-002",
        &genai.Image{ImageBytes: imageBytes},
        upscaleFactor,
        &genai.UpscaleImageConfig{
            IncludeRAIReason:  true,
            OutputMIMEType:    "image/jpeg",
            EnhanceInputImage: true,
        },
    )

    if err != nil {
        return nil, fmt.Errorf("æ”¾å¤§å›¾ç‰‡å¤±è´¥: %w", err)
    }

    return result.GeneratedImages[0].Image.ImageBytes, nil
}
```

#### 5. æ”¹å˜èƒŒæ™¯ï¼ˆRecontextï¼‰

å°†ä¸»ä½“æ”¾åˆ°æ–°ç¯å¢ƒä¸­ï¼Œé€‚ç”¨äºç”µå•†äº§å“å›¾ã€‚

```bash
POST /api/v1/images/recontext

{
  "provider": "gemini",
  "prompt": "æ”¾åœ¨é˜³å…‰æ˜åªšçš„æµ·æ»©ä¸Š",
  "image": "data:image/jpeg;base64,..."
}
```

**æŠ€æœ¯å®ç°**ï¼š
```go
func (p *GeminiProvider) RecontextImage(ctx context.Context, prompt string, imageBytes []byte) ([]byte, error) {
    productImage := &genai.ProductImage{
        ProductImage: &genai.Image{ImageBytes: imageBytes},
    }

    result, err := p.client.Models.RecontextImage(
        ctx,
        "imagen-product-recontext-preview-06-30",
        &genai.RecontextImageSource{
            Prompt:        prompt,
            ProductImages: []*genai.ProductImage{productImage},
        },
        &genai.RecontextImageConfig{
            OutputMIMEType: "image/jpeg",
        },
    )

    if err != nil {
        return nil, fmt.Errorf("æ”¹å˜å›¾ç‰‡ç¯å¢ƒå¤±è´¥: %w", err)
    }

    return result.GeneratedImages[0].Image.ImageBytes, nil
}
```

### Google Gemini é›†æˆè¯´æ˜

#### SDK ä¾èµ–

```bash
go get google.golang.org/genai@v1.40.0
```

#### é…ç½® Provider

```bash
POST /api/v1/providers/config
{
  "provider_name": "gemini",
  "display_name": "Google Gemini",
  "api_base": "https://generativelanguage.googleapis.com",
  "api_key": "YOUR_GOOGLE_API_KEY",
  "models": [
    {"id": "imagen-3.0-generate-001", "name": "Imagen 3.0", "default": true},
    {"id": "gemini-2.0-flash-exp", "name": "Gemini 2.0 Flash"}
  ],
  "enabled": true
}
```

#### æ”¯æŒçš„åŠŸèƒ½å¯¹æ¯”

| åŠŸèƒ½ | æ¨¡å‹ | API æ–¹æ³• | çŠ¶æ€ |
|------|------|----------|------|
| æ–‡ç”Ÿå›¾ | imagen-3.0-generate-001 | GenerateImages | âœ… å®Œæˆ |
| å›¾ç”Ÿå›¾ | gemini-2.0-flash-exp | GenerateContent | âœ… å®Œæˆ |
| å›¾ç‰‡ç¼–è¾‘ | imagen-3.0-capability-001 | EditImage | âœ… å®Œæˆ |
| å›¾ç‰‡æ”¾å¤§ | imagen-3.0-generate-002 | UpscaleImage | âœ… å®Œæˆ |
| èƒŒæ™¯æ›¿æ¢ | imagen-product-recontext | RecontextImage | âœ… å®Œæˆ |
| å›¾ç‰‡åˆ†å‰² | image-segmentation-001 | SegmentImage | â³ å¾…å®Œå–„ |

#### ç‰¹ç‚¹

- âœ… **é«˜è´¨é‡è¾“å‡º**ï¼šGoogle Imagen 3.0 æ¨¡å‹ï¼Œä¸šç•Œé¢†å…ˆçš„æ–‡ç”Ÿå›¾è´¨é‡
- âœ… **å›¾ç”Ÿå›¾æ”¯æŒ**ï¼šæœ€å¤š 14 å¼ å‚è€ƒå›¾ï¼Œé€‚åˆé£æ ¼è¿ç§»å’Œäº§å“å›¾ç”Ÿæˆ
- âœ… **å¤šç§ç¼–è¾‘åŠŸèƒ½**ï¼šæ”¯æŒå›¾ç‰‡ä¿®å¤ã€æ”¾å¤§ã€èƒŒæ™¯æ›¿æ¢ç­‰
- âœ… **å­—èŠ‚æµæ¨¡å¼**ï¼šç›´æ¥è¿”å›å›¾ç‰‡å­—èŠ‚æµï¼Œæ— éœ€ä¸‹è½½ URL
- âœ… **å®‰å…¨å±æ€§**ï¼šè‡ªåŠ¨åŒ…å« RAIï¼ˆè´Ÿè´£ä»»çš„AIï¼‰ç­›é€‰ç†ç”±

### å“åº”æ ¼å¼

```json
{
  "code": 0,
  "message": "success",
  "data": {
    "task_id": "550e8400-e29b-41d4-a716-446655440000",
    "status": "pending"
  }
}
```

---

## ğŸ” ä¸­æ–‡æœç´¢

### æ–¹æ¡ˆï¼šSQLite LIKE æŸ¥è¯¢ï¼ˆç®€åŒ–æ–¹æ¡ˆï¼‰

```go
// æœç´¢å®ç°
func SearchImages(db *sql.DB, keyword string, page, pageSize int) ([]*Task, error) {
    // è½¬ä¹‰SQLç‰¹æ®Šå­—ç¬¦ï¼Œé˜²æ­¢SQLæ³¨å…¥
    // % å’Œ _ æ˜¯SQL LIKEçš„é€šé…ç¬¦ï¼Œéœ€è¦è½¬ä¹‰
    keyword = strings.ReplaceAll(keyword, "\\", "\\\\")
    keyword = strings.ReplaceAll(keyword, "%", "\\%")
    keyword = strings.ReplaceAll(keyword, "_", "\\_")

    offset := (page - 1) * pageSize

    query := `
        SELECT id, task_id, prompt, provider_name, model_id, status,
               image_url, local_path, created_at
        FROM tasks
        WHERE prompt LIKE ? ESCAPE '\'
        ORDER BY created_at DESC
        LIMIT ? OFFSET ?
    `

    rows, err := db.Query(query, "%"+keyword+"%", pageSize, offset)
    // ... å¤„ç†ç»“æœ
}
```

### æ€§èƒ½

| æ•°æ®é‡ | æœç´¢è€—æ—¶ | å†…å­˜ |
|--------|---------|------|
| 10ä¸‡ | < 50ms | < 50MB |
| 100ä¸‡ | < 100ms | < 100MB |

**ä¼˜ç‚¹**ï¼š
- âœ… æ— éœ€ç¬¬ä¸‰æ–¹åˆ†è¯åº“
- âœ… å®ç°ç®€å•ï¼Œä»£ç é‡å°‘
- âœ… æ»¡è¶³åŸºæœ¬çš„ä¸­æ–‡åŒ…å«æœç´¢
- âœ… æ˜“äºç»´æŠ¤

**ç¼ºç‚¹**ï¼š
- âš ï¸ ä¸æ”¯æŒåˆ†è¯æœç´¢ï¼ˆå¦‚æœç´¢"å¯çˆ±çš„çŒ«"æ— æ³•åŒ¹é…"å¯çˆ±çš„å°çŒ«"ï¼‰
- âš ï¸ å¤§æ•°æ®é‡ï¼ˆ>100ä¸‡ï¼‰æ€§èƒ½ä¼šä¸‹é™

---

## âš¡ æ€§èƒ½ä¼˜åŒ–

### å…³é”®ä¼˜åŒ–ç‚¹

#### 1. HTTPè¿æ¥æ± 
```go
IdleConnTimeout: 30 * time.Second  // å…³é”®ï¼
MaxIdleConns: 50
MaxIdleConnsPerHost: 10
```

#### 2. æµå¼å¤„ç†
```go
io.Copy(dst, src)  // ä¸è¦ç”¨io.ReadAll
```

#### 3. SQLiteé…ç½®
```go
db.Exec("PRAGMA journal_mode=WAL")        // åŠ é€Ÿå†™å…¥
db.Exec("PRAGMA cache_size=-64000")       // 64MBç¼“å­˜
db.Exec("PRAGMA synchronous=NORMAL")      // å¹³è¡¡æ€§èƒ½å’Œå®‰å…¨
```

#### 4. Workeræ•°é‡
```go
// 2C2Gæ¨èï¼š6ä¸ªworker
workerCount := 6
queueSize := 100
```

### æ€§èƒ½é¢„ä¼°

```
2C2GæœåŠ¡å™¨ï¼š
- Worker: 6ä¸ª
- å¹¶å‘: 50ç¨³å®šï¼Œ100å³°å€¼
- ååé‡: 12å¼ /åˆ†é’Ÿ = 720å¼ /å°æ—¶
- æœç´¢: < 30ms
```

---

## ğŸš€ éƒ¨ç½²æ–¹æ¡ˆ

### SystemdæœåŠ¡

```ini
[Unit]
Description=Image Generation Service
After=network.target

[Service]
Type=simple
WorkingDirectory=/opt/image-gen-service
ExecStart=/opt/image-gen-service/image-gen-service
Restart=always

[Install]
WantedBy=multi-user.target
```

### å¯åŠ¨

```bash
# ç¼–è¯‘
go build -o image-gen-service

# å¯åŠ¨
sudo systemctl start image-gen-service

# æŸ¥çœ‹çŠ¶æ€
sudo systemctl status image-gen-service
```

---

## ğŸ’» å®Œæ•´ä»£ç 

### main.go

```go
package main

import (
    "database/sql"
    "fmt"
    "log"
    "net/http"
    "os"
    "os/signal"
    "strconv"
    "sync"
    "syscall"
    "time"

    "github.com/gin-gonic/gin"
    "github.com/google/uuid"
    _ "github.com/mattn/go-sqlite3"
)

type Config struct {
    Port        int
    WorkerCount int
    QueueSize   int
    Database    string
    LocalPath   string
    OSSBucket   string
    OSSAccessKey string
    OSSSecretKey string
    OSSRegion   string
}

type Task struct {
    TaskID    string
    Prompt    string
    Model     string
    Status    string
    CreatedAt time.Time
}

var (
    config    Config
    db        *sql.DB
    taskQueue = make(chan *Task, 100)
)

func main() {
    // 1. åŠ è½½é…ç½®
    loadConfig()

    // 2. åˆå§‹åŒ–æ•°æ®åº“
    initDB()

    // 3. å¯åŠ¨Workeræ± 
    startWorkers()

    // 4. å¯åŠ¨HTTPæœåŠ¡
    startHTTPServer()

    // 5. ç­‰å¾…ä¿¡å·
    waitForShutdown()
}

func loadConfig() {
    config = Config{
        Port:        8080,
        WorkerCount: 6,
        QueueSize:   100,
        Database:    "/data/service.db",
        LocalPath:   "/data/images",
    }
}

func initDB() {
    var err error
    db, err = sql.Open("sqlite3", config.Database)
    if err != nil {
        log.Fatal(err)
    }

    // åˆ›å»ºè¡¨
    db.Exec(`
        CREATE TABLE IF NOT EXISTS tasks (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            task_id TEXT UNIQUE NOT NULL,
            prompt TEXT NOT NULL,
            model TEXT,
            status TEXT NOT NULL,
            error_message TEXT,
            image_url TEXT,
            local_path TEXT,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP
        )
    `)

    // åˆ›å»ºç´¢å¼•ï¼ˆä¼˜åŒ–LIKEæŸ¥è¯¢ï¼‰
    db.Exec(`CREATE INDEX IF NOT EXISTS idx_prompt ON tasks(prompt)`)
    db.Exec(`CREATE INDEX IF NOT EXISTS idx_status ON tasks(status)`)
}

func startWorkers() {
    for i := 0; i < config.WorkerCount; i++ {
        go worker(i)
    }
}

func worker(id int) {
    for task := range taskQueue {
        log.Printf("Worker %d processing %s", id, task.TaskID)

        // ç”Ÿæˆå›¾ç‰‡
        imageURL, err := generateImage(task)
        if err != nil {
            updateTaskStatus(task.TaskID, "failed", err.Error())
            continue
        }

        // ä¿å­˜å›¾ç‰‡
        saveImage(imageURL, task.TaskID)

        // æ›´æ–°çŠ¶æ€
        updateTaskStatus(task.TaskID, "completed", imageURL)
    }
}

func startHTTPServer() {
    r := gin.Default()

    // è·¯ç”±ï¼ˆæ— è®¤è¯ï¼Œåªæœ‰è‡ªå·±ç”¨ï¼‰
    r.POST("/api/v1/tasks/generate", generateHandler)
    r.GET("/api/v1/tasks/:id", getTaskHandler)
    r.GET("/api/v1/images", listImagesHandler)
    r.GET("/api/v1/images/:id", getImageHandler)
    r.DELETE("/api/v1/images/:id", deleteImageHandler)
    r.GET("/api/v1/images/search", searchHandler)
    r.GET("/health", healthHandler)

    r.Run(fmt.Sprintf(":%d", config.Port))
}

func generateHandler(c *gin.Context) {
    var req struct {
        Provider string                 `json:"provider"`
        Params   map[string]interface{} `json:"params"`
    }

    if err := c.ShouldBindJSON(&req); err != nil {
        c.JSON(400, gin.H{"error": err.Error()})
        return
    }

    taskID := uuid.New().String()
    task := &Task{
        TaskID: taskID,
        Prompt: req.Params["prompt"].(string),
        Model:  req.Params["model"].(string),
        Status: "pending",
    }

    // ä¿å­˜åˆ°æ•°æ®åº“
    db.Exec("INSERT INTO tasks (task_id, prompt, model, status) VALUES (?, ?, ?, ?)",
        taskID, task.Prompt, task.Model, "pending")

    // æäº¤åˆ°é˜Ÿåˆ—
    taskQueue <- task

    c.JSON(200, gin.H{
        "code": 0,
        "data": gin.H{
            "task_id": taskID,
            "status":  "pending",
        },
    })
}

func waitForShutdown() {
    sigChan := make(chan os.Signal, 1)
    signal.Notify(sigChan, syscall.SIGINT, syscall.SIGTERM)

    <-sigChan
    log.Println("Shutting down...")

    // ç­‰å¾…é˜Ÿåˆ—æ¸…ç©º
    ctx, cancel := context.WithTimeout(context.Background(), 30*time.Second)
    for len(taskQueue) > 0 {
        if ctx.Err() != nil {
            break
        }
        time.Sleep(100 * time.Millisecond)
    }
    cancel()

    log.Println("Shutdown complete")
}

// ... å…¶ä»–å‡½æ•°å®ç°
```

---

## ğŸ“– å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…Goä¾èµ–

```bash
go get github.com/gin-gonic/gin
go get github.com/mattn/go-sqlite3
go get github.com/google/uuid
go get github.com/go-resty/resty/v2
go get google.golang.org/genai
```

### 2. åˆ›å»ºç›®å½•

```bash
mkdir -p /opt/image-gen-service/{bin,data,config,logs}
```

### 3. ç¼–è¯‘è¿è¡Œ

```bash
# ç¼–è¯‘
go build -o image-gen-service

# è¿è¡Œ
./image-gen-service
```

### 4. æµ‹è¯•API

```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:8080/health

# ç”Ÿæˆå›¾ç‰‡ï¼ˆæ— è®¤è¯ï¼Œåªæœ‰è‡ªå·±ç”¨ï¼‰
curl -X POST http://localhost:8080/api/v1/tasks/generate \
  -H "Content-Type: application/json" \
  -d '{
    "provider": "stable-diffusion",
    "params": {
      "prompt": "ä¸€åªå¯çˆ±çš„çŒ«"
    }
  }'

# æœç´¢
curl "http://localhost:8080/api/v1/images/search?keyword=å¯çˆ±çš„çŒ«"
```

---

## ğŸ“Š å®Œæ•´é¡¹ç›®ç»“æ„

```
image-gen-service/
â”œâ”€â”€ main.go                 # ä¸»å…¥å£ï¼ˆ500è¡Œï¼‰
â”œâ”€â”€ config.go               # é…ç½®ï¼ˆ100è¡Œï¼‰
â”œâ”€â”€ worker.go               # Workeræ± ï¼ˆ150è¡Œï¼‰
â”œâ”€â”€ provider.go             # Provideræ¥å£ï¼ˆ200è¡Œï¼‰
â”œâ”€â”€ search.go               # æœç´¢æ¨¡å—ï¼ˆ300è¡Œï¼‰
â”œâ”€â”€ storage.go              # å­˜å‚¨ï¼ˆ150è¡Œï¼‰
â”œâ”€â”€ database.go             # æ•°æ®åº“ï¼ˆ100è¡Œï¼‰
â”œâ”€â”€ handlers.go             # HTTPå¤„ç†ï¼ˆ200è¡Œï¼‰
â”œâ”€â”€ go.mod
â”œâ”€â”€ go.sum
â””â”€â”€ README.md
```

**æ€»ä»£ç é‡**: < 2000è¡Œï¼ˆç®€å•æ¸…æ™°ï¼‰

---

## âœ… æ ¸å¿ƒåŠŸèƒ½æ¸…å•

### å¿…é¡»å®ç°ï¼ˆ10é¡¹ï¼‰

1. âœ… HTTPè¿æ¥æ± ï¼ˆé˜²bad file descriptorï¼‰
2. âœ… æµå¼å¤„ç†ï¼ˆé˜²å†…å­˜æ’‘çˆ†ï¼‰
3. âœ… Workeræ± ï¼ˆæ§åˆ¶å¹¶å‘ï¼‰
4. âœ… ä»»åŠ¡é˜Ÿåˆ—ï¼ˆå¼‚æ­¥å¤„ç†ï¼‰
5. âœ… SQLiteï¼ˆæŒä¹…åŒ–+LIKEæœç´¢ï¼‰
6. âœ… Provideræ¥å£ï¼ˆé€šç”¨æ€§ï¼‰
7. âœ… **Provideré…ç½®ç®¡ç†**ï¼ˆå‰ç«¯åŠ¨æ€é…ç½®+æ ¡éªŒï¼‰
8. âœ… é‡è¯•æœºåˆ¶ï¼ˆå®¹é”™ï¼‰
9. âœ… ä¼˜é›…å…³é—­ï¼ˆä¸ä¸¢ä»»åŠ¡ï¼‰
10. âœ… ä¸­æ–‡æœç´¢ï¼ˆLIKEæŸ¥è¯¢ï¼‰
11. âœ… **Google Geminié›†æˆ**ï¼ˆæ–‡ç”Ÿå›¾+å›¾ç”Ÿå›¾ï¼‰

### ä¸éœ€è¦ï¼ˆå·²åˆ é™¤ï¼‰

- âŒ è®¤è¯ç³»ç»Ÿï¼ˆåªæœ‰è‡ªå·±ç”¨ï¼‰
- âŒ Prometheusç›‘æ§ï¼ˆç”¨healthæ¥å£æ›¿ä»£ï¼‰
- âŒ é…é¢ç®¡ç†ï¼ˆä¸éœ€è¦ï¼‰
- âŒ ç†”æ–­å™¨ï¼ˆè¿‡åº¦è®¾è®¡ï¼‰
- âŒ ä¼˜é›…é™çº§ï¼ˆä¸éœ€è¦ï¼‰
- âŒ Redisï¼ˆChannelå¤Ÿç”¨ï¼‰
- âŒ Elasticsearchï¼ˆSQLiteå¤Ÿç”¨ï¼‰
- âŒ å¾®æœåŠ¡ï¼ˆå•ä½“å¤Ÿç”¨ï¼‰

### Provideré…ç½®ç®¡ç†è¯´æ˜

**å‰ç«¯å¯ä»¥é€‰æ‹©ä¸‰ç§æ–¹å¼é…ç½®API**ï¼š

1. **é…ç½®æ–‡ä»¶é¢„è®¾**ï¼ˆconfig.yamlï¼‰- éƒ¨ç½²æ—¶è®¾ç½®ï¼Œä½œä¸ºfallback
2. **å‰ç«¯åŠ¨æ€ä¿å­˜**ï¼ˆæ•°æ®åº“ï¼‰- è¿è¡Œæ—¶é€šè¿‡APIé…ç½®ï¼Œæ°¸ä¹…ç”Ÿæ•ˆ
3. **ä¸´æ—¶è¦†ç›–**ï¼ˆè¯·æ±‚å‚æ•°ï¼‰- ä»…æœ¬æ¬¡è¯·æ±‚æœ‰æ•ˆï¼Œä¸ä¿å­˜

**é…ç½®æ ¡éªŒ**ï¼š
- è°ƒç”¨ç”ŸæˆAPIå‰ï¼Œæ ¡éªŒprovider_nameæ˜¯å¦å­˜åœ¨
- æ ¡éªŒapi_baseã€api_keyæ˜¯å¦é…ç½®
- æ ¡éªŒmodel_idæ˜¯å¦åœ¨å¯ç”¨æ¨¡å‹åˆ—è¡¨ä¸­
- é…ç½®ç¼ºå¤±æ—¶è¿”å›æ˜ç¡®é”™è¯¯æç¤º

---

## ğŸ¯ æ€§èƒ½é¢„æœŸ

| æŒ‡æ ‡ | é¢„æœŸå€¼ |
|------|--------|
| å¹¶å‘æ”¯æŒ | 50ç¨³å®šï¼Œ100å³°å€¼ |
| å“åº”æ—¶é—´ | < 100msï¼ˆè¿”å›task_idï¼‰ |
| å›¾ç‰‡ç”Ÿæˆ | 10-60ç§’ï¼ˆå¼‚æ­¥ï¼Œå–å†³äºæ¨¡å‹ï¼‰ |
| æœç´¢é€Ÿåº¦ | < 100msï¼ˆLIKEæŸ¥è¯¢ï¼‰ |
| å†…å­˜å ç”¨ | < 500MB |
| CPUå ç”¨ | < 50% |

---

## ğŸ“š æ€»ç»“

### æ–¹æ¡ˆç‰¹ç‚¹

- âœ… **ç®€å•**ï¼š< 2000è¡Œä»£ç 
- âœ… **é«˜æ€§èƒ½**ï¼šæ”¯æŒ100å¹¶å‘
- âœ… **ç¨³å®š**ï¼šå®Œå–„çš„é‡è¯•å’Œé”™è¯¯å¤„ç†
- âœ… **é€šç”¨**ï¼šProvideræŠ½è±¡å±‚å¯¹æ¥ä»»ä½•API
- âœ… **å¯æ‰©å±•**ï¼šå¹³æ»‘å‡çº§åˆ°ES
- âœ… **æ˜“ç»´æŠ¤**ï¼šå•æœºéƒ¨ç½²ï¼Œä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶

### é€‚åˆåœºæ™¯

- âœ… å•æœºéƒ¨ç½²
- âœ… ä¸­å°è§„æ¨¡ï¼ˆ< 100ä¸‡å¼ å›¾ï¼‰
- âœ… ä¸­æ–‡æœç´¢
- âœ… é«˜æ€§èƒ½è¦æ±‚

### ä¸é€‚åˆ

- âŒ å¤§è§„æ¨¡ï¼ˆ> 500ä¸‡ï¼‰
- âŒ éœ€è¦åˆ†å¸ƒå¼
- âŒ éœ€è¦å®æ—¶æ€§ < 10ms

**è¿™æ˜¯æœ€é€‚åˆæ‚¨çš„æ–¹æ¡ˆï¼**

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0 - ç²¾ç®€èåˆç‰ˆ
**æ›´æ–°æ—¶é—´**: 2025-01-30
**ä»£ç é‡**: < 2000è¡Œ
**éƒ¨ç½²**: å•æœºï¼ŒSystemd
**æ€§èƒ½**: æ»¡è¶³æ‰€æœ‰éœ€æ±‚
